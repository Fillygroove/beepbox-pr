var beepbox;!function(e){function t(e,t){for(var n=0;n<e.length;n++)e[n]*=t}function n(e){return!(!e||e&e-1)}function r(e){if(!n(e))throw new Error("FFT array length must be a power of 2.");return Math.round(Math.log(e)/Math.log(2))}function a(e){var t=e.length,n=r(t);if(n>16)throw new Error("FFT array length must not be greater than 2^16.");for(var a=16-n,s=0;t>s;s++){var o=void 0;if(o=(43690&s)>>1|(21845&s)<<1,o=(52428&o)>>2|(13107&o)<<2,o=(61680&o)>>4|(3855&o)<<4,o=(o>>8|(255&o)<<8)>>a,o>s){var i=e[s];e[s]=e[o],e[o]=i}}}function s(e){var t=e.length,n=r(t);if(4>t)throw new Error("FFT array length must be at least 4.");for(var s=n-1;s>=2;s--)for(var o=1<<s,i=o>>1,h=o<<1,l=2*Math.PI/h,p=Math.cos(l),u=Math.sin(l),c=2*p,f=0;t>f;f+=h){var v=f,m=v+i,d=v+o,g=d+i,C=d+o,b=e[v],y=e[d];e[v]=b+y,e[m]*=2,e[d]=b-y,e[g]*=2;for(var P=p,w=-u,k=1,S=0,M=1;i>M;M++){var A=v+M,x=d-M,N=d+M,B=C-M,D=e[A],O=e[x],I=e[N],T=e[B],F=D-O,E=I+T;e[A]=D+O,e[x]=T-I,e[N]=F*P-E*w,e[B]=E*P+F*w;var L=c*P-k,q=c*w-S;k=P,S=w,P=L,w=q}}for(var M=0;t>M;M+=4){var R=M+1,W=M+2,z=M+3,D=e[M],O=2*e[R],V=e[W],U=2*e[z],F=D+V,E=D-V;e[M]=F+O,e[R]=F-O,e[W]=E+U,e[z]=E-U}a(e)}e.scaleElementsByFactor=t,e.inverseRealFourierTransform=s}(beepbox||(beepbox={}));var beepbox;!function(e){function t(e,t,n){return{interval:e,time:t,volume:n}}function n(e,n,r,a,s){return void 0===s&&(s=!1),{pitches:[e],pins:[t(0,0,a),t(0,r-n,s?0:a)],start:n,end:r}}var r=0,a=0,s=function(){function t(){}return t.a=function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n];for(var r=t/e.length,n=0;n<e.length;n++)e[n]-=r;return new Float64Array(e)},t.getDrumWave=function(n){var r=t.c[n];if(null==r)if(r=new Float32Array(32768),t.c[n]=r,0==n)for(var a=1,s=0;32768>s;s++){r[s]=2*(1&a)-1;var o=a>>1;1==(a+o&1)&&(o+=16384),a=o}else if(1==n)for(var s=0;32768>s;s++)r[s]=2*Math.random()-1;else if(2==n)for(var a=1,s=0;32768>s;s++){r[s]=2*(1&a)-1;var o=a>>1;1==(a+o&1)&&(o+=32768),a=o}else if(3==n)for(var a=1,s=0;32768>s;s++){r[s]=2*(1&a)-1;var o=a>>1;1==(a+o&1)&&(o+=40),a=o}else{if(4!=n)throw new Error("Unrecognized drum index: "+n);t.drawNoiseSpectrum(r,10,11,1,1,0),t.drawNoiseSpectrum(r,11,14,-2,-2,0),e.inverseRealFourierTransform(r),e.scaleElementsByFactor(r,1/Math.sqrt(r.length))}return r},t.drawNoiseSpectrum=function(e,t,n,r,a,s){for(var o=11,i=1<<o,h=0|Math.pow(2,t),l=0|Math.pow(2,n),p=Math.log(2),u=h;l>u;u++){var c=Math.pow(2,r+(a-r)*(Math.log(u)/p-t)/(n-t));c*=Math.pow(u/i,s);var f=Math.random()*Math.PI*2;e[u]=Math.cos(f)*c,e[32768-u]=Math.sin(f)*c}},t.generateSineWave=function(){for(var e=new Float64Array(t.sineWaveLength+1),n=0;n<t.sineWaveLength+1;n++)e[n]=Math.sin(n*Math.PI*2/t.sineWaveLength);return e},t}();s.scaleNames=["easy :)","easy :(","island :)","island :(","blues :)","blues :(","normal :)","normal :(","dbl harmonic :)","dbl harmonic :(","enigma","expert"],s.scaleFlags=[[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1],[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0],[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1],[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1],[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1],[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0],[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0],[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],s.pianoScaleFlags=[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],s.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],s.pitchNames=["C",null,"D",null,"E","F",null,"G",null,"A",null,"B"],s.keyNames=["B","A♯","A","G♯","G","F♯","F","E","D♯","D","C♯","C"],s.keyTransposes=[23,22,21,20,19,18,17,16,15,14,13,12],s.tempoSteps=15,s.reverbRange=4,s.beatsPerBarMin=3,s.beatsPerBarMax=16,s.barCountMin=1,s.barCountMax=128,s.patternsPerChannelMin=1,s.patternsPerChannelMax=64,s.instrumentsPerChannelMin=1,s.instrumentsPerChannelMax=10,s.partNames=["÷3 (triplets)","÷4 (standard)","÷6","÷8"],s.partCounts=[3,4,6,8],s.waveNames=["triangle","square","pulse wide","pulse narrow","sawtooth","double saw","double pulse","spiky","plateau"],s.waveVolumes=[1,.5,.5,.5,.65,.5,.4,.4,.94],s.drumNames=["retro","white","clang","buzz","hollow"],s.drumVolumes=[.25,1,.4,.3,1.5],s.drumBasePitches=[69,69,69,69,96],s.drumPitchFilterMult=[100,8,100,100,1],s.drumWaveIsSoft=[!1,!0,!1,!1,!0],s.c=[null,null,null,null,null],s.filterNames=["none","bright","medium","soft","decay bright","decay medium","decay soft"],s.filterBases=[0,2,3.5,5,1,2.5,4],s.filterDecays=[0,0,0,0,10,7,4],s.filterVolumes=[.2,.4,.7,1,.5,.75,1],s.transitionNames=["seamless","sudden","smooth","slide"],s.effectNames=["none","vibrato light","vibrato delayed","vibrato heavy","tremolo light","tremolo heavy"],s.effectVibratos=[0,.15,.3,.45,0,0],s.effectTremolos=[0,0,0,0,.25,.5],s.effectVibratoDelays=[0,0,3,0,0,0],s.chorusNames=["union","shimmer","hum","honky tonk","dissonant","fifths","octaves","bowed","custom harmony"],s.chorusIntervals=[0,.02,.05,.1,.25,3.5,6,.02,.05],s.chorusOffsets=[0,0,0,0,0,3.5,6,0,0],s.chorusVolumes=[.7,.8,1,1,.9,.9,.8,1,1],s.chorusSigns=[1,1,1,1,1,1,1,-1,1],s.chorusHarmonizes=[!1,!1,!1,!1,!1,!1,!1,!1,!0],s.volumeNames=["loudest","loud","medium","quiet","quietest","mute"],s.volumeValues=[0,.5,1,1.5,2,-1],s.operatorCount=4,s.operatorAlgorithmNames=["1←(2 3 4)","1←(2 3←4)","1←2←(3 4)","1←(2 3)←4","1←2←3←4","1←3 2←4","1 2←(3 4)","1 2←3←4","(1 2)←3←4","(1 2)←(3 4)","1 2 3←4","(1 2 3)←4","1 2 3 4"],s.midiAlgorithmNames=["1<(2 3 4)","1<(2 3<4)","1<2<(3 4)","1<(2 3)<4","1<2<3<4","1<3 2<4","1 2<(3 4)","1 2<3<4","(1 2)<3<4","(1 2)<(3 4)","1 2 3<4","(1 2 3)<4","1 2 3 4"],s.operatorModulatedBy=[[[2,3,4],[],[],[]],[[2,3],[],[4],[]],[[2],[3,4],[],[]],[[2,3],[4],[4],[]],[[2],[3],[4],[]],[[3],[4],[],[]],[[],[3,4],[],[]],[[],[3],[4],[]],[[3],[3],[4],[]],[[3,4],[3,4],[],[]],[[],[],[4],[]],[[4],[4],[4],[]],[[],[],[],[]]],s.operatorAssociatedCarrier=[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,2,1,2],[1,2,2,2],[1,2,2,2],[1,2,2,2],[1,2,2,2],[1,2,3,3],[1,2,3,3],[1,2,3,4]],s.operatorCarrierCounts=[1,1,1,1,1,2,2,2,2,2,3,3,4],s.operatorCarrierChorus=[0,.04,-.073,.091],s.operatorAmplitudeMax=15,s.operatorFrequencyNames=["1×","~1×","2×","~2×","3×","4×","5×","6×","7×","8×","9×","11×","13×","16×","20×"],s.midiFrequencyNames=["1x","~1x","2x","~2x","3x","4x","5x","6x","7x","8x","9x","11x","13x","16x","20x"],s.operatorFrequencies=[1,1,2,2,3,4,5,6,7,8,9,11,13,16,20],s.operatorHzOffsets=[0,1.5,0,-1.3,0,0,0,0,0,0,0,0,0,0,0],s.operatorAmplitudeSigns=[1,-1,1,-1,1,1,1,1,1,1,1,1,1,1,1],s.operatorEnvelopeNames=["custom","steady","punch","flare 1","flare 2","flare 3","pluck 1","pluck 2","pluck 3","swell 1","swell 2","swell 3","tremolo1","tremolo2","tremolo3"],s.operatorEnvelopeType=[0,1,2,3,3,3,4,4,4,4,4,4,5,5,5],s.operatorEnvelopeSpeed=[0,0,0,32,8,2,32,8,2,32,8,2,4,2,1],s.operatorEnvelopeInverted=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!0,!1,!1,!1],s.operatorFeedbackNames=["1⟲","2⟲","3⟲","4⟲","1⟲ 2⟲","3⟲ 4⟲","1⟲ 2⟲ 3⟲","2⟲ 3⟲ 4⟲","1⟲ 2⟲ 3⟲ 4⟲","1→2","1→3","1→4","2→3","2→4","3→4","1→3 2→4","1→4 2→3","1→2→3→4"],s.midiFeedbackNames=["1","2","3","4","1 2","3 4","1 2 3","2 3 4","1 2 3 4","1>2","1>3","1>4","2>3","2>4","3>4","1>3 2>4","1>4 2>3","1>2>3>4"],s.operatorFeedbackIndices=[[[1],[],[],[]],[[],[2],[],[]],[[],[],[3],[]],[[],[],[],[4]],[[1],[2],[],[]],[[],[],[3],[4]],[[1],[2],[3],[]],[[],[2],[3],[4]],[[1],[2],[3],[4]],[[],[1],[],[]],[[],[],[1],[]],[[],[],[],[1]],[[],[],[2],[]],[[],[],[],[2]],[[],[],[],[3]],[[],[],[1],[2]],[[],[],[2],[1]],[[],[1],[2],[3]]],s.pitchChannelTypeNames=["chip","FM (expert)"],s.instrumentTypeNames=["chip","FM","noise"],s.pitchChannelColorsDim=["#0099a1","#a1a100","#c75000","#00a100","#d020d0","#7777b0"],s.pitchChannelColorsBright=["#25f3ff","#ffff25","#ff9752","#50ff50","#ff90ff","#a0a0ff"],s.pitchNoteColorsDim=["#00bdc7","#c7c700","#ff771c","#00c700","#e040e0","#8888d0"],s.pitchNoteColorsBright=["#92f9ff","#ffff92","#ffcdab","#a0ffa0","#ffc0ff","#d0d0ff"],s.drumChannelColorsDim=["#6f6f6f","#996633"],s.drumChannelColorsBright=["#aaaaaa","#ddaa77"],s.drumNoteColorsDim=["#aaaaaa","#cc9966"],s.drumNoteColorsBright=["#eeeeee","#f0d0bb"],s.midiPitchChannelNames=["cyan channel","yellow channel","orange channel","green channel","purple channel","blue channel"],s.midiDrumChannelNames=["gray channel","brown channel"],s.midiSustainInstruments=[71,80,70,68,81,81,81,81,74],s.midiDecayInstruments=[46,46,6,24,25,25,106,106,33],s.drumInterval=6,s.drumCount=12,s.pitchCount=37,s.maxPitch=84,s.pitchChannelCountMin=1,s.pitchChannelCountMax=6,s.drumChannelCountMin=0,s.drumChannelCountMax=2,s.waves=[s.a([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-0.2,-5/15,-7/15,-0.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-0.6,-7/15,-5/15,-0.2,-1/15]),s.a([1,-1]),s.a([1,-1,-1,-1]),s.a([1,-1,-1,-1,-1,-1,-1,-1]),s.a([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31]),s.a([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2]),s.a([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1]),s.a([1,-1,1,-1,1,0]),s.a([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])],s.sineWaveLength=256,s.sineWaveMask=s.sineWaveLength-1,s.sineWave=s.generateSineWave(),e.Config=s;var o=function(){function e(e,t,n,r){this.d=[],this.e=0;for(var a=n;r>a;a++){var s=e[t.charCodeAt(a)];this.d.push(s>>5&1),this.d.push(s>>4&1),this.d.push(s>>3&1),this.d.push(s>>2&1),this.d.push(s>>1&1),this.d.push(1&s)}}return e.prototype.read=function(e){for(var t=0;e>0;)t<<=1,t+=this.d[this.e++],e--;return t},e.prototype.readLongTail=function(e,t){for(var n=e,r=t;this.d[this.e++];)n+=1<<r,r++;for(;r>0;)r--,this.d[this.e++]&&(n+=1<<r);return n},e.prototype.readPartDuration=function(){return this.readLongTail(1,2)},e.prototype.readPinCount=function(){return this.readLongTail(1,0)},e.prototype.readPitchInterval=function(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)},e}(),i=function(){function e(){this.d=[]}return e.prototype.write=function(e,t){for(e--;e>=0;)this.d.push(t>>>e&1),e--},e.prototype.writeLongTail=function(e,t,n){if(e>n)throw new Error("value out of bounds");n-=e;for(var r=t;n>=1<<r;)this.d.push(1),n-=1<<r,r++;for(this.d.push(0);r>0;)r--,this.d.push(n>>>r&1)},e.prototype.writePartDuration=function(e){this.writeLongTail(1,2,e)},e.prototype.writePinCount=function(e){this.writeLongTail(1,0,e)},e.prototype.writePitchInterval=function(e){0>e?(this.write(1,1),this.writeLongTail(1,3,-e)):(this.write(1,0),this.writeLongTail(1,3,e))},e.prototype.concat=function(e){this.d=this.d.concat(e.d)},e.prototype.encodeBase64=function(e,t){for(var n=0;n<this.d.length;n+=6){var r=this.d[n]<<5|this.d[n+1]<<4|this.d[n+2]<<3|this.d[n+3]<<2|this.d[n+4]<<1|this.d[n+5];t.push(e[r])}return t},e.prototype.lengthBase64=function(){return Math.ceil(this.d.length/6)},e}();e.makeNotePin=t,e.makeNote=n;var h=function(){function e(){this.notes=[],this.instrument=0}return e.prototype.cloneNotes=function(){for(var e=[],r=0,a=this.notes;r<a.length;r++){var s=a[r],o=n(-1,s.start,s.end,3);o.pitches=s.pitches.concat(),o.pins=[];for(var i=0,h=s.pins;i<h.length;i++){var l=h[i];o.pins.push(t(l.interval,l.time,l.volume))}e.push(o)}return e},e.prototype.reset=function(){this.notes.length=0,this.instrument=0},e}();e.Pattern=h;var l=function(){function e(e){this.frequency=0,this.amplitude=0,this.envelope=0,this.reset(e)}return e.prototype.reset=function(e){this.frequency=0,this.amplitude=1>=e?s.operatorAmplitudeMax:0,this.envelope=0==e?0:1},e.prototype.copy=function(e){this.frequency=e.frequency,this.amplitude=e.amplitude,this.envelope=e.envelope},e}();e.Operator=l;var p=function(){function e(){this.type=0,this.wave=1,this.filter=1,this.transition=1,this.effect=0,this.chorus=0,this.volume=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1,this.operators=[];for(var e=0;e<s.operatorCount;e++)this.operators.push(new l(e))}return e.prototype.reset=function(){this.type=0,this.wave=1,this.filter=1,this.transition=1,this.effect=0,this.chorus=0,this.volume=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1;for(var e=0;e<this.operators.length;e++)this.operators[e].reset(e)},e.prototype.setTypeAndReset=function(e){switch(this.type=e,e){case 0:this.wave=1,this.filter=1,this.transition=1,this.effect=0,this.chorus=0,this.volume=0;break;case 1:this.wave=1,this.transition=1,this.volume=0;break;case 2:this.transition=1,this.effect=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1;for(var t=0;t<this.operators.length;t++)this.operators[t].reset(t)}},e.prototype.copy=function(e){this.type=e.type,this.wave=e.wave,this.filter=e.filter,this.transition=e.transition,this.effect=e.effect,this.chorus=e.chorus,this.volume=e.volume,this.algorithm=e.algorithm,this.feedbackType=e.feedbackType,this.feedbackAmplitude=e.feedbackAmplitude,this.feedbackEnvelope=e.feedbackEnvelope;for(var t=0;t<this.operators.length;t++)this.operators[t].copy(e.operators[t])},e}();e.Instrument=p;var u=function(){function e(){this.octave=0,this.instruments=[],this.patterns=[],this.bars=[]}return e}();e.Channel=u;var c=function(){function e(e){this.channels=[],this.f=[],void 0!=e?this.fromBase64String(e):this.initToDefault(!0)}return e.prototype.getChannelCount=function(){return this.pitchChannelCount+this.drumChannelCount},e.prototype.getChannelIsDrum=function(e){return e>=this.pitchChannelCount},e.prototype.getChannelColorDim=function(e){return e<this.pitchChannelCount?s.pitchChannelColorsDim[e]:s.drumChannelColorsDim[e-this.pitchChannelCount]},e.prototype.getChannelColorBright=function(e){return e<this.pitchChannelCount?s.pitchChannelColorsBright[e]:s.drumChannelColorsBright[e-this.pitchChannelCount]},e.prototype.getNoteColorDim=function(e){return e<this.pitchChannelCount?s.pitchNoteColorsDim[e]:s.drumNoteColorsDim[e-this.pitchChannelCount]},e.prototype.getNoteColorBright=function(e){return e<this.pitchChannelCount?s.pitchNoteColorsBright[e]:s.drumNoteColorsBright[e-this.pitchChannelCount]},e.prototype.initToDefault=function(e){if(void 0===e&&(e=!0),this.scale=0,this.key=s.keyNames.length-1,this.loopStart=0,this.loopLength=4,this.tempo=7,this.reverb=0,this.beatsPerBar=8,this.barCount=16,this.patternsPerChannel=8,this.partsPerBeat=4,this.instrumentsPerChannel=1,e){this.pitchChannelCount=3,this.drumChannelCount=1;for(var t=0;t<this.getChannelCount();t++){this.channels.length<=t&&(this.channels[t]=new u);var n=this.channels[t];n.octave=3-t;for(var r=0;r<this.patternsPerChannel;r++)n.patterns.length<=r?n.patterns[r]=new h:n.patterns[r].reset();n.patterns.length=this.patternsPerChannel;for(var a=0;a<this.instrumentsPerChannel;a++)n.instruments.length<=a?n.instruments[a]=new p:n.instruments[a].reset();n.instruments.length=this.instrumentsPerChannel;for(var o=0;o<this.barCount;o++)n.bars[o]=1;n.bars.length=this.barCount}this.channels.length=this.getChannelCount()}},e.prototype.toBase64String=function(){var t,n=[],r=e.g;n.push(r[e.h]),n.push(110,r[this.pitchChannelCount],r[this.drumChannelCount]),n.push(115,r[this.scale]),n.push(107,r[this.key]),n.push(108,r[this.loopStart>>6],r[63&this.loopStart]),n.push(101,r[this.loopLength-1>>6],r[this.loopLength-1&63]),n.push(116,r[this.tempo]),n.push(109,r[this.reverb]),n.push(97,r[this.beatsPerBar-1]),n.push(103,r[this.barCount-1>>6],r[this.barCount-1&63]),n.push(106,r[this.patternsPerChannel-1]),n.push(105,r[this.instrumentsPerChannel-1]),n.push(114,r[s.partCounts.indexOf(this.partsPerBeat)]),n.push(111);for(var a=0;a<this.getChannelCount();a++)n.push(r[this.channels[a].octave]);for(var a=0;a<this.getChannelCount();a++)for(var o=0;o<this.instrumentsPerChannel;o++){var h=this.channels[a].instruments[o];if(a<this.pitchChannelCount)if(n.push(84,r[h.type]),0==h.type)n.push(119,r[h.wave]),n.push(102,r[h.filter]),n.push(100,r[h.transition]),n.push(99,r[h.effect]),n.push(104,r[h.chorus]),n.push(118,r[h.volume]);else{if(1!=h.type)throw new Error("Unknown instrument type.");n.push(100,r[h.transition]),n.push(99,r[h.effect]),n.push(65,r[h.algorithm]),n.push(70,r[h.feedbackType]),n.push(66,r[h.feedbackAmplitude]),n.push(86,r[h.feedbackEnvelope]),n.push(81);for(var l=0;l<s.operatorCount;l++)n.push(r[h.operators[l].frequency]);n.push(80);for(var l=0;l<s.operatorCount;l++)n.push(r[h.operators[l].amplitude]);n.push(69);for(var l=0;l<s.operatorCount;l++)n.push(r[h.operators[l].envelope])}else n.push(84,r[2]),n.push(119,r[h.wave]),n.push(100,r[h.transition]),n.push(118,r[h.volume])}n.push(98),t=new i;for(var p=0;1<<p<this.patternsPerChannel+1;)p++;for(var a=0;a<this.getChannelCount();a++)for(var o=0;o<this.barCount;o++)t.write(p,this.channels[a].bars[o]);t.encodeBase64(r,n),n.push(112),t=new i;for(var u=0;1<<u<this.instrumentsPerChannel;)u++;for(var a=0;a<this.getChannelCount();a++){for(var c=this.getChannelIsDrum(a),f=c?0:12*this.channels[a].octave,v=(c?4:12)+f,m=c?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],d=[],o=0;o<m.length;o++)m[o]+=f;for(var g=0,C=this.channels[a].patterns;g<C.length;g++){var b=C[g];if(t.write(u,b.instrument),b.notes.length>0){t.write(1,1);for(var y=0,P=0,w=b.notes;P<w.length;P++){var k=w[P];k.start>y&&(t.write(2,0),t.writePartDuration(k.start-y));for(var S=new i,o=1;o<k.pitches.length;o++)S.write(1,1);k.pitches.length<4&&S.write(1,0),S.writePinCount(k.pins.length-1),S.write(2,k.pins[0].volume);for(var M=0,A=k.pitches[0],x=A,N=[],o=1;o<k.pins.length;o++){var B=k.pins[o],D=A+B.interval;x!=D?(S.write(1,1),N.push(D),x=D):S.write(1,0),S.writePartDuration(B.time-M),M=B.time,S.write(2,B.volume)}var O=String.fromCharCode.apply(null,S.encodeBase64(r,[])),I=d.indexOf(O);-1==I?(t.write(2,1),t.concat(S)):(t.write(1,1),t.writeLongTail(0,0,I),d.splice(I,1)),d.unshift(O),d.length>10&&d.pop();for(var T=k.pitches.concat(N),o=0;o<T.length;o++){var F=T[o],E=m.indexOf(F);if(-1==E){var L=0,q=v;if(F>q)for(;q!=F;)q++,-1==m.indexOf(q)&&L++;else for(;q!=F;)q--,-1==m.indexOf(q)&&L--;t.write(1,0),t.writePitchInterval(L)}else t.write(1,1),t.write(3,E),m.splice(E,1);m.unshift(F),m.length>8&&m.pop(),v=o==k.pitches.length-1?k.pitches[0]:F}y=k.end}y<this.beatsPerBar*this.partsPerBeat&&(t.write(2,0),t.writePartDuration(this.beatsPerBar*this.partsPerBeat-y))}else t.write(1,0)}}for(var R=t.lengthBase64(),W=[];R>0;)W.unshift(r[63&R]),R>>=6;if(n.push(r[W.length]),Array.prototype.push.apply(n,W),t.encodeBase64(r,n),n.length>=65535)throw new Error("Song hash code too long.");return String.fromCharCode.apply(null,n)},e.prototype.fromBase64String=function(r){if(null==r||""==r)return void this.initToDefault(!0);for(var a=0;r.charCodeAt(a)<=32;)a++;if(35==r.charCodeAt(a)&&a++,123==r.charCodeAt(a))return void this.fromJsonObject(JSON.parse(0==a?r:r.substring(a)));var i=e.i[r.charCodeAt(a++)];if(!(-1==i||i>e.h||i<e.j)){var l=3>i,c=4>i,f=5>i,v=6>i,m=e.i;if(this.initToDefault(v),l){for(var d=0,g=this.channels;d<g.length;d++){var C=g[d];C.instruments[0].transition=0}this.channels[3].instruments[0].wave=0}for(var b=0,y=-1;a<r.length;){var P=r.charCodeAt(a++),C=void 0;if(110==P){this.pitchChannelCount=m[r.charCodeAt(a++)],this.drumChannelCount=m[r.charCodeAt(a++)],this.pitchChannelCount=e.k(s.pitchChannelCountMin,s.pitchChannelCountMax+1,this.pitchChannelCount),this.drumChannelCount=e.k(s.drumChannelCountMin,s.drumChannelCountMax+1,this.drumChannelCount);for(var w=this.channels.length;w<this.getChannelCount();w++)this.channels[w]=new u;this.channels.length=this.getChannelCount()}else if(115==P)this.scale=m[r.charCodeAt(a++)],l&&10==this.scale&&(this.scale=11);else if(107==P)this.key=m[r.charCodeAt(a++)];else if(108==P)f?this.loopStart=m[r.charCodeAt(a++)]:this.loopStart=(m[r.charCodeAt(a++)]<<6)+m[r.charCodeAt(a++)];else if(101==P)f?this.loopLength=m[r.charCodeAt(a++)]:this.loopLength=(m[r.charCodeAt(a++)]<<6)+m[r.charCodeAt(a++)]+1;else if(116==P)c?this.tempo=[1,4,7,10][m[r.charCodeAt(a++)]]:this.tempo=m[r.charCodeAt(a++)],this.tempo=e.k(0,s.tempoSteps,this.tempo);else if(109==P)this.reverb=m[r.charCodeAt(a++)],this.reverb=e.k(0,s.reverbRange,this.reverb);else if(97==P)l?this.beatsPerBar=[6,7,8,9,10][m[r.charCodeAt(a++)]]:this.beatsPerBar=m[r.charCodeAt(a++)]+1,this.beatsPerBar=Math.max(s.beatsPerBarMin,Math.min(s.beatsPerBarMax,this.beatsPerBar));else if(103==P){this.barCount=(m[r.charCodeAt(a++)]<<6)+m[r.charCodeAt(a++)]+1,this.barCount=Math.max(s.barCountMin,Math.min(s.barCountMax,this.barCount));for(var k=0;k<this.getChannelCount();k++){for(var S=this.channels[k].bars.length;S<this.barCount;S++)this.channels[k].bars[S]=1;this.channels[k].bars.length=this.barCount}}else if(106==P){this.patternsPerChannel=m[r.charCodeAt(a++)]+1,this.patternsPerChannel=Math.max(s.patternsPerChannelMin,Math.min(s.patternsPerChannelMax,this.patternsPerChannel));for(var M=0;M<this.getChannelCount();M++){for(var A=this.channels[M].patterns.length;A<this.patternsPerChannel;A++)this.channels[M].patterns[A]=new h;this.channels[M].patterns.length=this.patternsPerChannel}}else if(105==P){this.instrumentsPerChannel=m[r.charCodeAt(a++)]+1,this.instrumentsPerChannel=Math.max(s.instrumentsPerChannelMin,Math.min(s.instrumentsPerChannelMax,this.instrumentsPerChannel));for(var x=0;x<this.getChannelCount();x++){for(var N=this.channels[x].instruments.length;N<this.instrumentsPerChannel;N++)this.channels[x].instruments[N]=new p;this.channels[x].instruments.length=this.instrumentsPerChannel}}else if(114==P)this.partsPerBeat=s.partCounts[m[r.charCodeAt(a++)]];else if(111==P)if(l)C=m[r.charCodeAt(a++)],this.channels[C].octave=e.k(0,5,m[r.charCodeAt(a++)]);else for(C=0;C<this.getChannelCount();C++)this.channels[C].octave=e.k(0,5,m[r.charCodeAt(a++)]);else if(84==P){y++,y>=this.instrumentsPerChannel&&(b++,y=0);var N=this.channels[b].instruments[y];N.setTypeAndReset(e.k(0,2,m[r.charCodeAt(a++)]))}else if(119==P)if(l)C=m[r.charCodeAt(a++)],this.channels[C].instruments[0].wave=e.k(0,s.waveNames.length,m[r.charCodeAt(a++)]);else if(v)for(C=0;C<this.getChannelCount();C++)for(var B=C>=this.pitchChannelCount,D=0;D<this.instrumentsPerChannel;D++)this.channels[C].instruments[D].wave=e.k(0,B?s.drumNames.length:s.waveNames.length,m[r.charCodeAt(a++)]);else{var B=b>=this.pitchChannelCount;this.channels[b].instruments[y].wave=e.k(0,B?s.drumNames.length:s.waveNames.length,m[r.charCodeAt(a++)])}else if(102==P)if(l)C=m[r.charCodeAt(a++)],this.channels[C].instruments[0].filter=[1,3,4,5][e.k(0,s.filterNames.length,m[r.charCodeAt(a++)])];else if(v)for(C=0;C<this.getChannelCount();C++)for(var D=0;D<this.instrumentsPerChannel;D++)this.channels[C].instruments[D].filter=e.k(0,s.filterNames.length,m[r.charCodeAt(a++)]+1);else this.channels[b].instruments[y].filter=e.k(0,s.filterNames.length,m[r.charCodeAt(a++)]);else if(100==P)if(l)C=m[r.charCodeAt(a++)],this.channels[C].instruments[0].transition=e.k(0,s.transitionNames.length,m[r.charCodeAt(a++)]);else if(v)for(C=0;C<this.getChannelCount();C++)for(var D=0;D<this.instrumentsPerChannel;D++)this.channels[C].instruments[D].transition=e.k(0,s.transitionNames.length,m[r.charCodeAt(a++)]);else this.channels[b].instruments[y].transition=e.k(0,s.transitionNames.length,m[r.charCodeAt(a++)]);else if(99==P)if(l){C=m[r.charCodeAt(a++)];var O=e.k(0,s.effectNames.length,m[r.charCodeAt(a++)]);1==O?O=3:3==O&&(O=5),this.channels[C].instruments[0].effect=O}else if(v)for(C=0;C<this.getChannelCount();C++)for(var D=0;D<this.instrumentsPerChannel;D++)this.channels[C].instruments[D].effect=e.k(0,s.effectNames.length,m[r.charCodeAt(a++)]);else this.channels[b].instruments[y].effect=e.k(0,s.effectNames.length,m[r.charCodeAt(a++)]);else if(104==P)if(l)C=m[r.charCodeAt(a++)],this.channels[C].instruments[0].chorus=e.k(0,s.chorusNames.length,m[r.charCodeAt(a++)]);else if(v)for(C=0;C<this.getChannelCount();C++)for(var D=0;D<this.instrumentsPerChannel;D++)this.channels[C].instruments[D].chorus=e.k(0,s.chorusNames.length,m[r.charCodeAt(a++)]);else this.channels[b].instruments[y].chorus=e.k(0,s.chorusNames.length,m[r.charCodeAt(a++)]);else if(118==P)if(l)C=m[r.charCodeAt(a++)],this.channels[C].instruments[0].volume=e.k(0,s.volumeNames.length,m[r.charCodeAt(a++)]);else if(v)for(C=0;C<this.getChannelCount();C++)for(var D=0;D<this.instrumentsPerChannel;D++)this.channels[C].instruments[D].volume=e.k(0,s.volumeNames.length,m[r.charCodeAt(a++)]);else this.channels[b].instruments[y].volume=e.k(0,s.volumeNames.length,m[r.charCodeAt(a++)]);else if(65==P)this.channels[b].instruments[y].algorithm=e.k(0,s.operatorAlgorithmNames.length,m[r.charCodeAt(a++)]);else if(70==P)this.channels[b].instruments[y].feedbackType=e.k(0,s.operatorFeedbackNames.length,m[r.charCodeAt(a++)]);else if(66==P)this.channels[b].instruments[y].feedbackAmplitude=e.k(0,s.operatorAmplitudeMax+1,m[r.charCodeAt(a++)]);else if(86==P)this.channels[b].instruments[y].feedbackEnvelope=e.k(0,s.operatorEnvelopeNames.length,m[r.charCodeAt(a++)]);else if(81==P)for(var I=0;I<s.operatorCount;I++)this.channels[b].instruments[y].operators[I].frequency=e.k(0,s.operatorFrequencyNames.length,m[r.charCodeAt(a++)]);else if(80==P)for(var I=0;I<s.operatorCount;I++)this.channels[b].instruments[y].operators[I].amplitude=e.k(0,s.operatorAmplitudeMax+1,m[r.charCodeAt(a++)]);else if(69==P)for(var I=0;I<s.operatorCount;I++)this.channels[b].instruments[y].operators[I].envelope=e.k(0,s.operatorEnvelopeNames.length,m[r.charCodeAt(a++)]);else if(98==P){var T=void 0;if(l){C=m[r.charCodeAt(a++)];var F=m[r.charCodeAt(a++)];T=Math.ceil(.5*F);for(var E=new o(m,r,a,a+T),D=0;F>D;D++)this.channels[C].bars[D]=E.read(3)+1}else if(f){for(var L=0;1<<L<this.patternsPerChannel;)L++;T=Math.ceil(this.getChannelCount()*this.barCount*L/6);var E=new o(m,r,a,a+T);for(C=0;C<this.getChannelCount();C++)for(var D=0;D<this.barCount;D++)this.channels[C].bars[D]=E.read(L)+1}else{for(var L=0;1<<L<this.patternsPerChannel+1;)L++;T=Math.ceil(this.getChannelCount()*this.barCount*L/6);var E=new o(m,r,a,a+T);for(C=0;C<this.getChannelCount();C++)for(var D=0;D<this.barCount;D++)this.channels[C].bars[D]=E.read(L)}a+=T}else if(112==P){var q=0;if(l)C=m[r.charCodeAt(a++)],a++,q=m[r.charCodeAt(a++)],q<<=6,q+=m[r.charCodeAt(a++)];else{C=0;for(var R=m[r.charCodeAt(a++)];R>0;)q<<=6,q+=m[r.charCodeAt(a++)],R--}var E=new o(m,r,a,a+q);a+=q;for(var W=0;1<<W<this.instrumentsPerChannel;)W++;for(;;){for(var z=this.getChannelIsDrum(C),V=z?0:12*this.channels[C].octave,U=null,Y=null,j=(z?4:12)+V,G=z?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],H=[],D=0;D<G.length;D++)G[D]+=V;for(var D=0;D<this.patternsPerChannel;D++){var J=this.channels[C].patterns[D];if(J.reset(),J.instrument=E.read(W),l||0!=E.read(1))for(var K=0,Q=J.notes;K<this.beatsPerBar*this.partsPerBeat;){var X=1==E.read(1),Z=!1,$=0;if(X?$=E.readLongTail(0,0):Z=1==E.read(1),X||Z){var _=void 0,ee=void 0,te=void 0;if(X)_=H[$],H.splice($,1);else{for(_={},_.pitchCount=1;_.pitchCount<4&&1==E.read(1);)_.pitchCount++;_.pinCount=E.readPinCount(),_.initialVolume=E.read(2),_.pins=[],_.length=0,_.bendCount=0;for(var ne=0;ne<_.pinCount;ne++)ee={},ee.pitchBend=1==E.read(1),ee.pitchBend&&_.bendCount++,_.length+=E.readPartDuration(),ee.time=_.length,ee.volume=E.read(2),_.pins.push(ee)}H.unshift(_),H.length>10&&H.pop(),U=n(0,K,K+_.length,_.initialVolume),U.pitches=[],U.pins.length=1;for(var re=[],ne=0;ne<_.pitchCount+_.bendCount;ne++){var ae=1==E.read(1);if(ae){var se=E.read(3);te=G[se],G.splice(se,1)}else{var oe=E.readPitchInterval();te=j;for(var ie=oe;ie>0;){for(te++;-1!=G.indexOf(te);)te++;ie--}for(;0>ie;){for(te--;-1!=G.indexOf(te);)te--;ie++}}G.unshift(te),G.length>8&&G.pop(),ne<_.pitchCount?U.pitches.push(te):re.push(te),j=ne==_.pitchCount-1?U.pitches[0]:te}re.unshift(U.pitches[0]);for(var he=0,le=_.pins;he<le.length;he++){var pe=le[he];pe.pitchBend&&re.shift(),Y=t(re[0]-U.pitches[0],pe.time,pe.volume),U.pins.push(Y)}K=U.end,Q.push(U)}else{var ue=E.readPartDuration();K+=ue}}}if(l)break;if(C++,C>=this.getChannelCount())break}}}}},e.prototype.toJsonObject=function(t,n,r){void 0===t&&(t=!0),void 0===n&&(n=1),void 0===r&&(r=!0);for(var a=[],o=0;o<this.getChannelCount();o++){for(var i=[],h=this.getChannelIsDrum(o),l=0;l<this.instrumentsPerChannel;l++){var p=this.channels[o].instruments[l];if(h)i.push({type:s.instrumentTypeNames[2],volume:20*(5-p.volume),wave:s.drumNames[p.wave],transition:s.transitionNames[p.transition]});else if(0==p.type)i.push({type:s.instrumentTypeNames[p.type],volume:20*(5-p.volume),wave:s.waveNames[p.wave],transition:s.transitionNames[p.transition],filter:s.filterNames[p.filter],chorus:s.chorusNames[p.chorus],effect:s.effectNames[p.effect]});else{if(1!=p.type)throw new Error("Unrecognized instrument type");for(var u=[],c=0,f=p.operators;c<f.length;c++){var v=f[c];u.push({frequency:s.operatorFrequencyNames[v.frequency],amplitude:v.amplitude,envelope:s.operatorEnvelopeNames[v.envelope]})}i.push({type:s.instrumentTypeNames[p.type],transition:s.transitionNames[p.transition],effect:s.effectNames[p.effect],algorithm:s.operatorAlgorithmNames[p.algorithm],feedbackType:s.operatorFeedbackNames[p.feedbackType],feedbackAmplitude:p.feedbackAmplitude,feedbackEnvelope:s.operatorEnvelopeNames[p.feedbackEnvelope],operators:u})}}for(var m=[],d=0,g=this.channels[o].patterns;d<g.length;d++){for(var C=g[d],b=[],y=0,P=C.notes;y<P.length;y++){for(var w=P[y],k=[],S=0,M=w.pins;S<M.length;S++){var A=M[S];k.push({tick:A.time+w.start,pitchBend:A.interval,volume:Math.round(100*A.volume/3)})}b.push({pitches:w.pitches,points:k})}m.push({instrument:C.instrument+1,notes:b})}var x=[];if(t)for(var l=0;l<this.loopStart;l++)x.push(this.channels[o].bars[l]);for(var N=0;n>N;N++)for(var l=this.loopStart;l<this.loopStart+this.loopLength;l++)x.push(this.channels[o].bars[l]);if(r)for(var l=this.loopStart+this.loopLength;l<this.barCount;l++)x.push(this.channels[o].bars[l]);a.push({type:h?"drum":"pitch",octaveScrollBar:this.channels[o].octave,instruments:i,patterns:m,sequence:x})}return{format:e.l,version:e.h,scale:s.scaleNames[this.scale],key:s.keyNames[this.key],introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beatsPerBar,ticksPerBeat:this.partsPerBeat,beatsPerMinute:this.getBeatsPerMinute(),reverb:this.reverb,channels:a}},e.prototype.fromJsonObject=function(r){if(this.initToDefault(!0),r){var a=r.version;if(!(a>e.l)){if(this.scale=11,void 0!=r.scale){var o={"romani :)":8,"romani :(":9},i=void 0!=o[r.scale]?o[r.scale]:s.scaleNames.indexOf(r.scale);-1!=i&&(this.scale=i)}if(void 0!=r.key)if("number"==typeof r.key)this.key=s.keyNames.length-1-(r.key+1200>>>0)%s.keyNames.length;else if("string"==typeof r.key){var l=r.key,c=l.charAt(0).toUpperCase(),f=l.charAt(1).toLowerCase(),v={C:11,D:9,E:7,F:6,G:4,A:2,B:0},m={"#":-1,"♯":-1,b:1,"♭":1},d=v[c],g=m[f];void 0!=d&&(void 0!=g&&(d+=g),0>d&&(d+=12),d%=12,this.key=d)}if(void 0!=r.beatsPerMinute){var C=0|r.beatsPerMinute;this.tempo=Math.round(4+9*Math.log(C/120)/Math.LN2),this.tempo=e.k(0,s.tempoSteps,this.tempo)}void 0!=r.reverb&&(this.reverb=e.k(0,s.reverbRange,0|r.reverb)),void 0!=r.beatsPerBar&&(this.beatsPerBar=Math.max(s.beatsPerBarMin,Math.min(s.beatsPerBarMax,0|r.beatsPerBar))),void 0!=r.ticksPerBeat&&(this.partsPerBeat=0|r.ticksPerBeat,-1==s.partCounts.indexOf(this.partsPerBeat)&&(this.partsPerBeat=s.partCounts[s.partCounts.length-1]));var b=1,y=1,P=1;if(r.channels)for(var w=0,k=r.channels;w<k.length;w++){var S=k[w];S.instruments&&(b=Math.max(b,0|S.instruments.length)),S.patterns&&(y=Math.max(y,0|S.patterns.length)),S.sequence&&(P=Math.max(P,0|S.sequence.length))}this.instrumentsPerChannel=b,this.patternsPerChannel=y,this.barCount=P,void 0!=r.introBars&&(this.loopStart=e.k(0,this.barCount,0|r.introBars)),void 0!=r.loopBars&&(this.loopLength=e.k(1,this.barCount-this.loopStart+1,0|r.loopBars));var M=0,A=0;if(r.channels)for(var x=0;x<r.channels.length;x++){var S=r.channels[x];this.channels.length<=x&&(this.channels[x]=new u),void 0!=S.octaveScrollBar&&(this.channels[x].octave=e.k(0,5,0|S.octaveScrollBar));for(var N=this.channels[x].instruments.length;N<this.instrumentsPerChannel;N++)this.channels[x].instruments[N]=new p;
this.channels[x].instruments.length=this.instrumentsPerChannel;for(var N=this.channels[x].patterns.length;N<this.patternsPerChannel;N++)this.channels[x].patterns[N]=new h;this.channels[x].patterns.length=this.patternsPerChannel;for(var N=0;N<this.barCount;N++)this.channels[x].bars[N]=1;this.channels[x].bars.length=this.barCount;var B=!1;B=S.type?"drum"==S.type:x>=3,B?A++:M++;for(var N=0;N<this.instrumentsPerChannel;N++){var D=this.channels[x].instruments[N],O=void 0;S.instruments&&(O=S.instruments[N]),void 0==O&&(O={});var I={binary:0},T=O.transition||O.envelope;if(D.transition=void 0!=I[T]?I[T]:s.transitionNames.indexOf(T),-1==D.transition&&(D.transition=1),B)D.type=s.instrumentTypeNames.indexOf(O.type),-1==D.type&&(D.type=2),void 0!=O.volume?D.volume=e.k(0,s.volumeNames.length,Math.round(5-(0|O.volume)/20)):D.volume=0,D.wave=s.drumNames.indexOf(O.wave),-1==D.wave&&(D.wave=1);else if(D.type=s.instrumentTypeNames.indexOf(O.type),-1==D.type&&(D.type=0),0==D.type){void 0!=O.volume?D.volume=e.k(0,s.volumeNames.length,Math.round(5-(0|O.volume)/20)):D.volume=0,D.wave=s.waveNames.indexOf(O.wave),-1==D.wave&&(D.wave=1);var F={"sustain sharp":1,"sustain medium":2,"sustain soft":3,"decay sharp":4};D.filter=void 0!=F[O.filter]?F[O.filter]:s.filterNames.indexOf(O.filter),-1==D.filter&&(D.filter=0),D.chorus=s.chorusNames.indexOf(O.chorus),-1==D.chorus&&(D.chorus=0),D.effect=s.effectNames.indexOf(O.effect),-1==D.effect&&(D.effect=0)}else{if(1!=D.type)throw new Error("Unrecognized instrument type.");D.effect=s.effectNames.indexOf(O.effect),-1==D.effect&&(D.effect=0),D.algorithm=s.operatorAlgorithmNames.indexOf(O.algorithm),-1==D.algorithm&&(D.algorithm=0),D.feedbackType=s.operatorFeedbackNames.indexOf(O.feedbackType),-1==D.feedbackType&&(D.feedbackType=0),void 0!=O.feedbackAmplitude?D.feedbackAmplitude=e.k(0,s.operatorAmplitudeMax+1,0|O.feedbackAmplitude):D.feedbackAmplitude=0,D.feedbackEnvelope=s.operatorEnvelopeNames.indexOf(O.feedbackEnvelope),-1==D.feedbackEnvelope&&(D.feedbackEnvelope=0);for(var E=0;E<s.operatorCount;E++){var L=D.operators[E],q=void 0;O.operators&&(q=O.operators[E]),void 0==q&&(q={}),L.frequency=s.operatorFrequencyNames.indexOf(q.frequency),-1==L.frequency&&(L.frequency=0),void 0!=q.amplitude?L.amplitude=e.k(0,s.operatorAmplitudeMax+1,0|q.amplitude):L.amplitude=0,L.envelope=s.operatorEnvelopeNames.indexOf(q.envelope),-1==L.envelope&&(L.envelope=0)}}}for(var N=0;N<this.patternsPerChannel;N++){var R=this.channels[x].patterns[N],W=void 0;if(S.patterns&&(W=S.patterns[N]),void 0!=W&&(R.instrument=e.k(0,this.instrumentsPerChannel,(0|W.instrument)-1),W.notes&&W.notes.length>0))for(var z=Math.min(this.beatsPerBar*this.partsPerBeat,W.notes.length>>>0),V=0,E=0;E<W.notes.length&&!(E>=z);E++){var U=W.notes[E];if(U&&U.pitches&&U.pitches.length>=1&&U.points&&U.points.length>=2){var Y=n(0,0,0,0);Y.pitches=[],Y.pins=[];for(var j=0;j<U.pitches.length;j++){var G=0|U.pitches[j];if(-1==Y.pitches.indexOf(G)&&(Y.pitches.push(G),Y.pitches.length>=4))break}if(!(Y.pitches.length<1)){for(var H=V,J=0,j=0;j<U.points.length;j++){var K=U.points[j];if(void 0!=K&&void 0!=K.tick){var Q=void 0==K.pitchBend?0:0|K.pitchBend,X=0|K.tick,Z=void 0==K.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|K.volume)/100)));if(!(X>this.beatsPerBar*this.partsPerBeat)){if(0==Y.pins.length){if(H>X)continue;Y.start=X,J=Q}else if(H>=X)continue;H=X,Y.pins.push(t(Q-J,X-Y.start,Z))}}}if(!(Y.pins.length<2)){Y.end=Y.pins[Y.pins.length-1].time+Y.start;for(var $=B?s.drumCount-1:s.maxPitch,_=$,ee=0,j=0;j<Y.pitches.length;j++)Y.pitches[j]+=J,(Y.pitches[j]<0||Y.pitches[j]>$)&&(Y.pitches.splice(j,1),j--),Y.pitches[j]<_&&(_=Y.pitches[j]),Y.pitches[j]>ee&&(ee=Y.pitches[j]);if(!(Y.pitches.length<1)){for(var j=0;j<Y.pins.length;j++){var te=Y.pins[j];te.interval+_<0&&(te.interval=-_),te.interval+ee>$&&(te.interval=$-ee),j>=2&&te.interval==Y.pins[j-1].interval&&te.interval==Y.pins[j-2].interval&&te.volume==Y.pins[j-1].volume&&te.volume==Y.pins[j-2].volume&&(Y.pins.splice(j-1,1),j--)}R.notes.push(Y),V=Y.end}}}}}}for(var N=0;N<this.barCount;N++)this.channels[x].bars[N]=S.sequence?Math.min(this.patternsPerChannel,S.sequence[N]>>>0):0}this.pitchChannelCount=M,this.drumChannelCount=A,this.channels.length=this.getChannelCount()}}},e.k=function(e,t,n){return t-=1,t>=n?n>=e?n:e:t},e.prototype.getPattern=function(e,t){var n=this.channels[e].bars[t];return 0==n?null:this.channels[e].patterns[n-1]},e.prototype.getPatternInstrument=function(e,t){var n=this.getPattern(e,t);return null==n?0:n.instrument},e.prototype.getBeatsPerMinute=function(){return Math.round(120*Math.pow(2,(-4+this.tempo)/9))},e.prototype.getChannelFingerprint=function(e,t){var n=0;if(!(t<this.pitchChannelCount))return"d";if(0==e.type)return"c";if(1!=e.type)throw new Error("Unknown instrument type.");return this.f[n++]="f",this.f[n++]=e.algorithm,this.f[n++]=e.feedbackType,this.f.length=n,this.f.join("")},e}();c.l="BeepBox",c.j=2,c.h=6,c.i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0],c.g=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],e.Song=c;var f=function(){function e(){this.active=!1,this.sample=0,this.phases=[],this.phaseDeltas=[],this.volumeStarts=[],this.volumeDeltas=[],this.phaseDeltaScale=0,this.filter=0,this.filterScale=0,this.vibratoScale=0,this.harmonyMult=0,this.harmonyVolumeMult=1,this.feedbackOutputs=[],this.feedbackMult=0,this.feedbackDelta=0,this.reset()}return e.prototype.reset=function(){for(var e=0;e<s.operatorCount;e++)this.phases[e]=0,this.feedbackOutputs[e]=0;this.sample=0},e}(),v=function(){function t(e){void 0===e&&(e=null);var t=this;this.samplesPerSecond=44100,this.effectDuration=.14,this.effectAngle=2*Math.PI/(this.effectDuration*this.samplesPerSecond),this.effectYMult=2*Math.cos(this.effectAngle),this.limitDecay=1/(2*this.samplesPerSecond),this.song=null,this.pianoPressed=!1,this.pianoPitch=[0],this.pianoChannel=0,this.enableIntro=!0,this.enableOutro=!1,this.loopCount=-1,this.volume=1,this.playheadInternal=0,this.bar=0,this.beat=0,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=0,this.paused=!0,this.tones=[],this.stillGoing=!1,this.effectPhase=0,this.limit=0,this.samplesForReverb=null,this.reverbDelayLine=new Float32Array(16384),this.reverbDelayPos=0,this.reverbFeedback0=0,this.reverbFeedback1=0,this.reverbFeedback2=0,this.reverbFeedback3=0,this.audioCtx=null,this.scriptNode=null,this.audioProcessCallback=function(e){var n=e.outputBuffer,r=n.getChannelData(0);t.synthesize(r,n.length)},null!=e&&this.setSong(e)}return t.warmUpSynthesizer=function(e){if(null!=e)for(var n=0;n<e.instrumentsPerChannel;n++){for(var r=e.pitchChannelCount;r<e.pitchChannelCount+e.drumChannelCount;r++)s.getDrumWave(e.channels[r].instruments[n].wave);for(var r=0;r<e.getChannelCount();r++)t.getGeneratedSynthesizer(e,e.channels[r].instruments[n],r)}},t.operatorAmplitudeCurve=function(e){return(Math.pow(16,e/15)-1)/15},Object.defineProperty(t.prototype,"playing",{get:function(){return!this.paused},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"playhead",{get:function(){return this.playheadInternal},set:function(e){if(null!=this.song){this.playheadInternal=Math.max(0,Math.min(this.song.barCount,e));var t=this.playheadInternal;this.bar=Math.floor(t),t=this.song.beatsPerBar*(t-this.bar),this.beat=Math.floor(t),t=this.song.partsPerBeat*(t-this.beat),this.part=Math.floor(t),t=4*(t-this.part),this.arpeggio=Math.floor(t);var n=this.getSamplesPerArpeggio();t=n*(t-this.arpeggio),this.arpeggioSampleCountdown=Math.floor(n-t),this.bar<this.song.loopStart&&(this.enableIntro=!0),this.bar>this.song.loopStart+this.song.loopLength&&(this.enableOutro=!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalSamples",{get:function(){if(null==this.song)return 0;var e=4*this.getSamplesPerArpeggio()*this.song.partsPerBeat*this.song.beatsPerBar,t=this.loopCount;0>t&&(t=1);var n=this.song.loopLength*t;return this.enableIntro&&(n+=this.song.loopStart),this.enableOutro&&(n+=this.song.barCount-(this.song.loopStart+this.song.loopLength)),n*e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalSeconds",{get:function(){return this.totalSamples/this.samplesPerSecond},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalBars",{get:function(){return null==this.song?0:this.song.barCount},enumerable:!0,configurable:!0}),t.prototype.setSong=function(e){"string"==typeof e?this.song=new c(e):e instanceof c&&(this.song=e)},t.prototype.play=function(){if(this.paused){this.paused=!1,t.warmUpSynthesizer(this.song);var e=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;this.audioCtx=this.audioCtx||new e,this.scriptNode=this.audioCtx.createScriptProcessor?this.audioCtx.createScriptProcessor(2048,0,1):this.audioCtx.createJavaScriptNode(2048,0,1),this.scriptNode.onaudioprocess=this.audioProcessCallback,this.scriptNode.channelCountMode="explicit",this.scriptNode.channelInterpretation="speakers",this.scriptNode.connect(this.audioCtx.destination),this.samplesPerSecond=this.audioCtx.sampleRate,this.effectAngle=2*Math.PI/(this.effectDuration*this.samplesPerSecond),this.effectYMult=2*Math.cos(this.effectAngle),this.limitDecay=1/(2*this.samplesPerSecond)}},t.prototype.pause=function(){this.paused||(this.paused=!0,this.scriptNode.disconnect(this.audioCtx.destination),this.audioCtx.close&&(this.audioCtx.close(),this.audioCtx=null),this.scriptNode=null)},t.prototype.snapToStart=function(){this.bar=0,this.enableIntro=!0,this.snapToBar()},t.prototype.snapToBar=function(e){void 0!==e&&(this.bar=e),this.playheadInternal=this.bar,this.beat=0,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=0,this.effectPhase=0;for(var t=0,n=this.tones;t<n.length;t++){var r=n[t];r.reset()}this.reverbDelayPos=0,this.reverbFeedback0=0,this.reverbFeedback1=0,this.reverbFeedback2=0,this.reverbFeedback3=0;for(var a=0;a<this.reverbDelayLine.length;a++)this.reverbDelayLine[a]=0},t.prototype.nextBar=function(){if(this.song){var e=this.bar;this.bar++,this.enableOutro?this.bar>=this.song.barCount&&(this.bar=this.enableIntro?0:this.song.loopStart):(this.bar>=this.song.loopStart+this.song.loopLength||this.bar>=this.song.barCount)&&(this.bar=this.song.loopStart),this.playheadInternal+=this.bar-e}},t.prototype.prevBar=function(){if(this.song){var e=this.bar;this.bar--,this.bar<0&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.bar>=this.song.barCount&&(this.bar=this.song.barCount-1),this.bar<this.song.loopStart&&(this.enableIntro=!0),!this.enableOutro&&this.bar>=this.song.loopStart+this.song.loopLength&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.playheadInternal+=this.bar-e}},t.prototype.synthesize=function(n,s){if(null!=this.song){for(var o=this.song.getChannelCount(),i=this.tones.length;o>i;i++)this.tones[i]=new f;this.tones.length=o;var h=this.getSamplesPerArpeggio(),l=0,p=!1;(0==this.arpeggioSampleCountdown||this.arpeggioSampleCountdown>h)&&(this.arpeggioSampleCountdown=h),this.part>=this.song.partsPerBeat&&(this.beat++,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=h),this.beat>=this.song.beatsPerBar&&(this.bar++,this.beat=0,this.part=0,this.arpeggio=0,this.arpeggioSampleCountdown=h,-1==this.loopCount&&(this.bar<this.song.loopStart&&!this.enableIntro&&(this.bar=this.song.loopStart),this.bar>=this.song.loopStart+this.song.loopLength&&!this.enableOutro&&(this.bar=this.song.loopStart))),this.bar>=this.song.barCount&&(this.enableOutro?(this.bar=0,this.enableIntro=!0,p=!0,this.pause()):this.bar=this.song.loopStart),this.bar>=this.song.loopStart&&(this.enableIntro=!1);for(var u=performance.now(),i=0;s>i;)n[i++]=0,n[i++]=0,n[i++]=0,n[i++]=0;(null==this.samplesForReverb||this.samplesForReverb.length<s)&&(this.samplesForReverb=new Float32Array(s));for(var c=this.samplesForReverb,i=0;s>i;)c[i++]=0,c[i++]=0,c[i++]=0,c[i++]=0;for(;s>l&&!p;){for(var v=0;v<this.song.getChannelCount();v++){var m=this.song.channels[v].instruments[this.song.getPatternInstrument(v,this.bar)];t.generatedSynthesizersByChannel[v]=t.getGeneratedSynthesizer(this.song,m,v)}for(;s>l;){for(var d=s-l,g=this.arpeggioSampleCountdown<=d?this.arpeggioSampleCountdown:d,v=0;v<this.song.getChannelCount();v++){var m=this.song.channels[v].instruments[this.song.getPatternInstrument(v,this.bar)];t.computeTone(this,this.song,v,h,g,m);var C=this.tones[v],b=this.song.getChannelIsDrum(v)?n:c;C.active&&t.generatedSynthesizersByChannel[v](this,b,l,g,C,m)}if(l+=g,this.effectPhase=(this.effectPhase+this.effectAngle*g)%(2*Math.PI),this.arpeggioSampleCountdown-=g,this.arpeggioSampleCountdown<=0&&(this.arpeggio++,this.arpeggioSampleCountdown=h,4==this.arpeggio&&(this.arpeggio=0,this.part++,this.part==this.song.partsPerBeat&&(this.part=0,this.beat++,this.beat==this.song.beatsPerBar)))){this.beat=0,this.bar++,this.effectPhase=0,this.bar<this.song.loopStart?this.enableIntro||(this.bar=this.song.loopStart):this.enableIntro=!1,this.bar>=this.song.loopStart+this.song.loopLength&&(this.loopCount>0&&this.loopCount--,(this.loopCount>0||!this.enableOutro)&&(this.bar=this.song.loopStart)),this.bar>=this.song.barCount&&(this.bar=0,this.enableIntro=!0,p=!0,this.pause());break}}}for(var y=+this.volume,P=this.reverbDelayLine,w=0|this.reverbDelayPos,k=+this.reverbFeedback0,S=+this.reverbFeedback1,M=+this.reverbFeedback2,A=+this.reverbFeedback3,x=.425*Math.pow(this.song.reverb/e.Config.reverbRange,.667),N=+this.limitDecay,B=+this.limit,i=0;s>i;i++){var D=c[i],O=w+3041&16383,I=w+6426&16383,T=w+10907&16383,F=P[w]+D,E=P[O],L=P[I],q=P[T],R=-F+E,W=-F-E,z=-L+q,V=-L-q;k+=.5*((R+z)*x-k),S+=.5*((W+V)*x-S),M+=.5*((R-z)*x-M),A+=.5*((W-V)*x-A),P[O]=k,P[I]=S,P[T]=M,P[w]=A,w=w+1&16383;var U=n[i]+F+E+L+q,Y=0>U?-U:U;Y>B&&(B=Y),n[i]=U/(.75*B+.25)*y,B-=N}this.reverbDelayPos=w,this.reverbFeedback0=k,this.reverbFeedback1=S,this.reverbFeedback2=M,this.reverbFeedback3=A,this.limit=B,this.playheadInternal=(((this.arpeggio+1-this.arpeggioSampleCountdown/h)/4+this.part)/this.song.partsPerBeat+this.beat)/this.song.beatsPerBar+this.bar;var j=performance.now()-u;r+=s,a+=j}else for(var i=0;s>i;i++)n[i]=0},t.computeOperatorEnvelope=function(e,t,n,r){switch(s.operatorEnvelopeType[e]){case 0:return r;case 1:return 1;case 4:var a=1/(1+t*s.operatorEnvelopeSpeed[e]);return s.operatorEnvelopeInverted[e]?1-a:a;case 5:return.5-.5*Math.cos(2*n*Math.PI*s.operatorEnvelopeSpeed[e]);case 2:return Math.max(1,2-10*t);case 3:var o=s.operatorEnvelopeSpeed[e],i=.25/Math.sqrt(o);return i>t?t/i:1/(1+(t-i)*o);default:throw new Error("Unrecognized operator envelope type.")}},t.computeTone=function(e,n,r,a,o,i){var h=n.getChannelIsDrum(r),l=e.tones[r],p=n.getPattern(r,e.bar),u=e.pianoPressed&&r==e.pianoChannel,c=h?s.drumBasePitches[i.wave]:s.keyTransposes[n.key],f=h?s.drumInterval:1,v=h?s.drumWaveIsSoft[i.wave]?24:60:48,m=4*a/e.samplesPerSecond,d=1/n.partsPerBeat;l.phaseDeltaScale=0,l.filter=1,l.filterScale=1,l.vibratoScale=0,l.harmonyMult=1,l.harmonyVolumeMult=1,l.active=!1;for(var g=0,C=e.arpeggio,b=e.arpeggioSampleCountdown,y=null,P=!0,w=0,k=0,S=1,M=1,A=0,x=0,N=0,B=0,D=0,O=0,I=0;I<s.operatorCount;I++)l.phaseDeltas[I]=0,l.volumeStarts[I]=0,l.volumeDeltas[I]=0;if(u)y=e.pianoPitch,S=M=1,A=x=1,P=!1;else if(null!=p){for(var T=e.part+e.beat*n.partsPerBeat,F=null,E=null,L=null,I=0;I<p.notes.length;I++)if(p.notes[I].end<=T)E=p.notes[I];else if(p.notes[I].start<=T&&p.notes[I].end>T)F=p.notes[I];else if(p.notes[I].start>T){L=p.notes[I];break}if(null!=F&&null!=E&&E.end!=F.start&&(E=null),null!=F&&null!=L&&L.start!=F.end&&(L=null),null!=F){y=F.pitches,g=T-F.start;var q=void 0;for(q=1;q<F.pins.length-1&&!(F.pins[q].time+F.start>T);q++);var R=F.pins[q-1],W=F.pins[q],z=4*F.start,V=4*F.end,U=4*(F.start+R.time),Y=4*(F.start+W.time),j=4*T+C,G=4*T+C+1,H=(j-U)/(Y-U),J=(G-U)/(Y-U),K=R.volume+(W.volume-R.volume)*H,Q=R.volume+(W.volume-R.volume)*J,X=1,Z=1,$=R.interval+(W.interval-R.interval)*H,_=R.interval+(W.interval-R.interval)*J,ee=R.time+(W.time-R.time)*H,te=R.time+(W.time-R.time)*J,ne=ee,re=te,ae=1-b/a,se=1-(b-o)/a;P=j+ae-z==0;var oe=i.transition;j==z&&(0==oe?P=!1:2==oe?X=0:3==oe&&(null==E?X=0:0==E.pins[E.pins.length-1].volume||0==F.pins[0].volume?X=0:($=.5*(E.pitches[0]+E.pins[E.pins.length-1].interval-F.pitches[0]),ne=.5*E.pins[E.pins.length-1].time,P=!1))),G==V&&(0==oe?null==L&&F.start+W.time!=n.partsPerBeat*n.beatsPerBar&&(Z=0):1==oe||2==oe?Z=0:3==oe&&(null==L?Z=0:0==F.pins[F.pins.length-1].volume||0==L.pins[0].volume?Z=0:(_=.5*(L.pitches[0]-F.pitches[0]+F.pins[F.pins.length-1].interval),re*=.5))),w=$+(_-$)*ae,k=$+(_-$)*se,A=e.volumeConversion(K+(Q-K)*ae),x=e.volumeConversion(K+(Q-K)*se),S=X+(Z-X)*ae,M=X+(Z-X)*se,N=F.start+ee+(te-ee)*ae,B=F.start+ee+(te-ee)*se,D=ne+(re-ne)*ae,O=ne+(re-ne)*se}}if(null!=y){var ie=1/e.samplesPerSecond;if(l.active=!0,h||1!=i.type){var he=y[0];if(s.chorusHarmonizes[i.chorus]){var le=0;2==y.length?le=y[1]-y[0]:3==y.length?le=y[(C>>1)+1]-y[0]:4==y.length&&(le=y[(3==C?1:C)+1]-y[0]),l.harmonyMult=Math.pow(2,le/12),l.harmonyVolumeMult=Math.pow(2,-le/v)}else 2==y.length?he=y[C>>1]:3==y.length?he=y[3==C?1:C]:4==y.length&&(he=y[C]);var pe=(he+w)*f,ue=(he+k)*f,ce=e.frequencyFromPitch(c+pe),fe=Math.pow(2,-pe/v),ve=Math.pow(2,-ue/v);h&&s.drumWaveIsSoft[i.wave]&&(l.filter=Math.min(1,ce*ie*s.drumPitchFilterMult[i.wave]));var me=void 0;if(h)me=.19*s.drumVolumes[i.wave];else{var de=s.filterDecays[i.filter];l.filter=Math.pow(2,-de*m*D);var ge=Math.pow(2,-de*m*O);l.filterScale=Math.pow(ge/l.filter,1/o),me=.135*s.waveVolumes[i.wave]*s.filterVolumes[i.filter]*s.chorusVolumes[i.chorus]}P&&!h&&l.reset(),l.phaseDeltas[0]=ce*ie;var Ce=5==i.volume?0:Math.pow(2,-s.volumeValues[i.volume]);l.volumeStarts[0]=S*A*fe*me*Ce;var be=M*x*ve*me*Ce;l.volumeDeltas[0]=(be-l.volumeStarts[0])/o}else{for(var ye=1,Pe=0,we=s.operatorCarrierCounts[i.algorithm],I=0;I<s.operatorCount;I++){var ke=s.operatorAssociatedCarrier[i.algorithm][I]-1,he=y[I<y.length?I:ke<y.length?ke:0],Se=s.operatorFrequencies[i.operators[I].frequency],Me=s.operatorCarrierChorus[ke],pe=(he+w)*f+Me,ce=Se*e.frequencyFromPitch(c+pe)+s.operatorHzOffsets[i.operators[I].frequency];l.phaseDeltas[I]=ce*ie*s.sineWaveLength,P&&l.reset();var Ae=t.operatorAmplitudeCurve(i.operators[I].amplitude),xe=Ae*s.operatorAmplitudeSigns[i.operators[I].frequency],Ne=xe,be=xe;if(we>I){var Be=.03,ue=(he+k)*f,fe=Math.pow(2,-pe/v),ve=Math.pow(2,-ue/v);Ne*=fe*Be*S,be*=ve*Be*M,Pe+=Ae}else Ne*=1.5*s.sineWaveLength,be*=1.5*s.sineWaveLength,ye*=1-Math.min(1,i.operators[I].amplitude/15);var De=i.operators[I].envelope;Ne*=t.computeOperatorEnvelope(De,m*D,d*N,A),be*=t.computeOperatorEnvelope(De,m*O,d*B,x),l.volumeStarts[I]=Ne,l.volumeDeltas[I]=(be-Ne)/o}var Oe=.3*s.sineWaveLength*i.feedbackAmplitude/15,Ie=Oe*t.computeOperatorEnvelope(i.feedbackEnvelope,m*D,d*N,A),Te=Oe*t.computeOperatorEnvelope(i.feedbackEnvelope,m*O,d*B,x);l.feedbackMult=Ie,l.feedbackDelta=(Te-l.feedbackMult)/o,ye*=1-i.feedbackAmplitude/15,ye*=1-Math.min(1,Math.max(0,Pe-1)/2);for(var I=0;we>I;I++)l.volumeStarts[I]*=1+3*ye,l.volumeDeltas[I]*=1+3*ye}l.phaseDeltaScale=Math.pow(2,(k-w)*f/12/o),l.vibratoScale=g<s.effectVibratoDelays[i.effect]?0:Math.pow(2,s.effectVibratos[i.effect]/12)-1}else{h||l.reset();for(var I=0;I<s.operatorCount;I++)l.phaseDeltas[0]=0,l.volumeStarts[0]=0,l.volumeDeltas[0]=0}},t.getGeneratedSynthesizer=function(e,n,r){if(e.getChannelIsDrum(r)||1!=n.type){if(e.getChannelIsDrum(r)||0!=n.type){if(e.getChannelIsDrum(r))return t.noiseSynth;throw new Error("Unrecognized instrument type: "+n.type)}return t.chipSynth}var a=e.getChannelFingerprint(n,r);if(void 0==t.fmSynthFunctionCache[a]){for(var o=[],i=0,h=t.fmSourceTemplate;i<h.length;i++){var l=h[i];if(-1!=l.indexOf("// CARRIER OUTPUTS")){if(!e.getChannelIsDrum(r)&&1==n.type){for(var p=[],u=0;u<s.operatorCarrierCounts[n.algorithm];u++)p.push("operator"+u+"Scaled");o.push(l.replace("/*operator#Scaled*/",p.join(" + ")))}}else if(-1!=l.indexOf("// INSERT OPERATOR COMPUTATION HERE"))for(var u=s.operatorCount-1;u>=0;u--)for(var c=0,f=t.operatorSourceTemplate;c<f.length;c++){var v=f[c];if(-1!=v.indexOf("/* + operator@Scaled*/")){for(var m="",d=0,g=s.operatorModulatedBy[n.algorithm][u];d<g.length;d++){var C=g[d];m+=" + operator"+(C-1)+"Scaled"}var b=s.operatorFeedbackIndices[n.feedbackType][u];if(b.length>0){m+=" + feedbackMult * (";for(var y=[],P=0,w=b;P<w.length;P++){var C=w[P];y.push("operator"+(C-1)+"Output")}m+=y.join(" + ")+")"}o.push(v.replace(/\#/g,u+"").replace("/* + operator@Scaled*/",m))}else o.push(v.replace(/\#/g,u+""))}else if(-1!=l.indexOf("#"))for(var u=0;u<s.operatorCount;u++)o.push(l.replace(/\#/g,u+""));else o.push(l)}t.fmSynthFunctionCache[a]=new Function("synth","data","bufferIndex","runLength","tone","instrument",o.join("\n"))}return t.fmSynthFunctionCache[a]},t.chipSynth=function(t,n,r,a,s,o){var i=+t.effectYMult,h=+Math.sin(t.effectPhase),l=+Math.sin(t.effectPhase-t.effectAngle),p=e.Config.waves[o.wave],u=+p.length,c=+Math.pow(2,-e.Config.filterBases[o.filter]),f=+e.Config.effectTremolos[o.effect],v=+Math.pow(2,(e.Config.chorusOffsets[o.chorus]+e.Config.chorusIntervals[o.chorus])/12),m=Math.pow(2,(e.Config.chorusOffsets[o.chorus]-e.Config.chorusIntervals[o.chorus])/12)*s.harmonyMult,d=s.harmonyVolumeMult*e.Config.chorusSigns[o.chorus];0==o.chorus&&(s.phases[1]=s.phases[0]);for(var g=m/v,C=s.phaseDeltas[0]*v,b=+s.phaseDeltaScale,y=+s.volumeStarts[0],P=+s.volumeDeltas[0],w=s.filter*c,k=+s.filterScale,S=+s.vibratoScale,M=s.phases[0]%1,A=s.phases[1]%1,x=+s.sample,N=r+a;N>r;){var B=1+S*h,D=1+f*(h-1),O=h;h=i*h-l,l=O;var I=p[0|M*u],T=p[0|A*u]*d,F=(I+T)*y*D;x+=(F-x)*w,y+=P,M+=C*B,A+=C*B*g,w*=k,M-=0|M,A-=0|A,C*=b,n[r]+=x,r++}s.phases[0]=M,s.phases[1]=A,s.sample=x},t.noiseSynth=function(t,n,r,a,s,o){for(var i=e.Config.getDrumWave(o.wave),h=+s.phaseDeltas[0]/32768,l=+s.phaseDeltaScale,p=+s.volumeStarts[0],u=+s.volumeDeltas[0],c=+s.filter,f=s.phases[0]%1,v=+s.sample,m=r+a;m>r;)v+=(i[0|32768*f]*p-v)*c,p+=u,f+=h,f-=0|f,h*=l,n[r]+=v,r++;s.phases[0]=f,s.sample=v},t.prototype.frequencyFromPitch=function(e){return 440*Math.pow(2,(e-69)/12)},t.prototype.volumeConversion=function(e){return Math.pow(e/3,1.5)},t.prototype.getSamplesPerArpeggio=function(){if(null==this.song)return 0;var e=this.song.getBeatsPerMinute(),t=e/60,n=t*this.song.partsPerBeat,r=4*n;return Math.floor(this.samplesPerSecond/r)},t}();v.negativePhaseGuard=1e3,v.generatedSynthesizersByChannel=[],v.fmSynthFunctionCache={},v.fmSourceTemplate=("\n			// TODO: Skip this line and oscillator below unless using an effect:\n			var effectYMult = +synth.effectYMult;\n			var effectY     = +Math.sin(synth.effectPhase);\n			var prevEffectY = +Math.sin(synth.effectPhase - synth.effectAngle);\n			\n			var sineWave = beepbox.Config.sineWave;\n			\n			var tremoloScale = +beepbox.Config.effectTremolos[instrument.effect];\n			\n			var phaseDeltaScale = +tone.phaseDeltaScale;\n			var vibratoScale = +tone.vibratoScale;\n			var operator#Phase       = +((tone.phases[#] % 1) + "+v.negativePhaseGuard+") * "+s.sineWaveLength+";\n			var operator#PhaseDelta  = +tone.phaseDeltas[#];\n			var operator#OutputMult  = +tone.volumeStarts[#];\n			var operator#OutputDelta = +tone.volumeDeltas[#];\n			var operator#Output      = +tone.feedbackOutputs[#];\n			var feedbackMult         = +tone.feedbackMult;\n			var feedbackDelta        = +tone.feedbackDelta;\n			var sample = +tone.sample;\n			\n			var stopIndex = bufferIndex + runLength;\n			while (bufferIndex < stopIndex) {\n				var vibrato = 1.0 + vibratoScale * effectY;\n				var tremolo = 1.0 + tremoloScale * (effectY - 1.0);\n				var temp = effectY;\n				effectY = effectYMult * effectY - prevEffectY;\n				prevEffectY = temp;\n				\n				// INSERT OPERATOR COMPUTATION HERE\n				sample = tremolo * (/*operator#Scaled*/); // CARRIER OUTPUTS\n				feedbackMult += feedbackDelta;\n				operator#OutputMult += operator#OutputDelta;\n				operator#Phase += operator#PhaseDelta * vibrato;\n				operator#PhaseDelta *= phaseDeltaScale;\n				\n				data[bufferIndex] += sample;\n				bufferIndex++;\n			}\n			\n			tone.phases[#] = operator#Phase / "+s.sineWaveLength+";\n			tone.feedbackOutputs[#] = operator#Output;\n			tone.sample = sample;\n		").split("\n"),v.operatorSourceTemplate=("\n				var operator#PhaseMix = operator#Phase/* + operator@Scaled*/;\n				var operator#PhaseInt = operator#PhaseMix|0;\n				var operator#Index    = operator#PhaseInt & "+s.sineWaveMask+";\n				var operator#Sample   = sineWave[operator#Index];\n				operator#Output       = operator#Sample + (sineWave[operator#Index + 1] - operator#Sample) * (operator#PhaseMix - operator#PhaseInt);\n				var operator#Scaled   = operator#OutputMult * operator#Output;\n		").split("\n"),e.Synth=v}(beepbox||(beepbox={}));